<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AI Process Performance Analyzer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    #top { display:flex; gap:16px; }
    #anomalies { width: 40%; }
    #charts { width: 60%; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px; border-bottom:1px solid #ddd; }
    .score-high { color: red; font-weight: bold; }
    .score-medium { color: orange; }
  </style>
</head>
<body>
  <h2>AI Process Performance Analyzer â€” Live</h2>
  <div id="top">
    <div id="anomalies">
      <h3>Flagged Processes</h3>
      <div id="flag_list"></div>
    </div>
    <div id="charts">
      <h3>System Snapshot</h3>
      <div id="sys_chart"></div>
    </div>
  </div>
  <script>
    // simple chart placeholder
    Plotly.newPlot('sys_chart', [
      { y: [], type: 'line', name: 'CPU %', line: {color: 'blue'} },
      { y: [], type: 'line', name: 'Memory %', line: {color: 'green'} }
    ], {
        title: 'Live System Metrics',
        xaxis: {title: 'Time'},
        yaxis: {range: [0, 100], title: 'Usage %'}
    });

    function renderFlags(anomalies) {
      let html = '<table><tr><th>PID</th><th>Name</th><th>Score</th><th>Reason</th></tr>';
      for (const a of anomalies) {
        let cls = a.score > 0.75 ? 'score-high' : (a.score > 0.4 ? 'score-medium' : '');
        let expl = a.explanation;
        if (Array.isArray(expl)) {
          expl = expl.map(e => `${e[0]} (z=${e[1].toFixed(2)})`).join('; ');
        } else {
          expl = JSON.stringify(expl);
        }
        html += `<tr><td>${a.pid}</td><td>${a.name||''}</td><td class="${cls}">${a.score.toFixed(3)}</td><td>${expl}</td></tr>`;
      }
      html += '</table>';
      document.getElementById('flag_list').innerHTML = html;
    }

    // connect websocket
    const ws = new WebSocket(`ws://${window.location.host}/ws/stream`);
    ws.onmessage = (evt) => {
        const data = JSON.parse(evt.data);
        const anomalies = data.anomalies || [];
        renderFlags(anomalies);

    // Add this block to update the chart
        if (data.system) {
            Plotly.extendTraces('sys_chart', {
                y: [[data.system.cpu_percent], [data.system.mem_percent]]
            }, [0, 1]); // 0 = 1st trace (CPU), 1 = 2nd trace (Mem)
        }
    };
    ws.onopen = () => console.log("Connected to server stream");
    ws.onclose = () => console.log("Disconnected");
  </script>
</body>
</html>
